<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard - Library Reading Challenge</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background: #FFF5E1; /* Sand background */
    color: #6B4F3F; /* Dark brown text */
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .profile {
    position: relative;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #FFD166;
    color: #6B4F3F;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    cursor: pointer;
  }

  .dropdown {
    display: none;
    position: absolute;
    top: 50px;
    right: 0;
    background: #FFD166;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    min-width: 100px;
    z-index: 10;
  }

  .dropdown button {
    width: 100%;
    padding: 8px;
    background: none;
    border: none;
    text-align: left;
    cursor: pointer;
  }

  .dropdown button:hover {
    background: #FFB800;
  }

  .section {
    margin-top: 30px;
  }

  .progress-bar-container {
    width: 100%;
    background: #FFD16666; /* light sand tint */
    border-radius: 20px;
    overflow: hidden;
    height: 30px;
    margin-top: 10px;
  }

  .progress-bar {
    height: 100%;
    background: #FFB800; /* filled portion */
    text-align: right;
    padding-right: 10px;
    color: #6B4F3F;
    font-weight: bold;
    line-height: 30px;
    border-radius: 20px 0 0 20px;
  }

  .leaderboard {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
  }

  .leaderboard-item {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .leaderboard-bar {
    flex-grow: 1;
    background: #FFD16666;
    border-radius: 10px;
    height: 25px;
    position: relative;
  }

  .leaderboard-fill {
    background: #FFB800;
    height: 100%;
    border-radius: 10px 0 0 10px;
    display: flex;
    align-items: center;
    padding-left: 10px;
    color: #6B4F3F;
    font-weight: bold;
  }

  input, button {
    width: 100%;
    margin: 8px 0;
    padding: 10px;
    box-sizing: border-box;
    border-radius: 4px;
    border: 1px solid #6B4F3F33;
  }

  button {
    background: #FFB800;
    color: #6B4F3F;
    cursor: pointer;
    font-weight: bold;
    border: none;
  }

  button:hover {
    background: #FFD166;
  }

</style>
</head>
<body>

<header>
  <h2 id="welcome">Welcome back!</h2>
  <div class="profile" id="profileIcon">U
    <div class="dropdown" id="profileDropdown">
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</header>

<div class="section">
  <h3>Community Progress</h3>
  <div class="progress-bar-container">
    <div class="progress-bar" id="communityProgress">0%</div>
  </div>
</div>

<div class="section">
  <h3>Your Logged Minutes</h3>
  <div id="userMinutes">0 minutes</div>
</div>

<div class="section">
  <h3>Log More Minutes</h3>
  <input type="number" id="logMinutesInput" placeholder="Enter minutes (max 120)">
  <button id="logMinutesBtn">Log Minutes</button>
  <div id="logMessage"></div>
</div>

<div class="section">
  <h3>Top 10 Leaderboard</h3>
  <div class="leaderboard" id="leaderboard"></div>
</div>

<script>
  const SUPABASE_URL = 'YOUR_SUPABASE_URL';
  const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const username = sessionStorage.getItem('username');
  if (!username) {
    window.location.href = 'login.html';
  }

  document.getElementById('welcome').textContent = `Welcome back, ${username}!`;

  // Profile dropdown toggle
  const profileIcon = document.getElementById('profileIcon');
  const profileDropdown = document.getElementById('profileDropdown');

  profileIcon.addEventListener('click', () => {
    profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block';
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    sessionStorage.removeItem('username');
    window.location.href = 'login.html';
  });

  async function loadDashboard() {
    // Load user info
    const { data: userData } = await supabase
      .from('Userdetails')
      .select('minutes_logged')
      .eq('user_name', username)
      .single();

    const userMinutes = userData?.minutes_logged || 0;
    document.getElementById('userMinutes').textContent = `${userMinutes} minutes`;

    // Load leaderboard
    const { data: leaderboardData } = await supabase
      .from('Userdetails')
      .select('user_name, minutes_logged')
      .order('minutes_logged', { ascending: false })
      .limit(10);

    const leaderboardEl = document.getElementById('leaderboard');
    leaderboardEl.innerHTML = '';

    leaderboardData.forEach(user => {
      const barContainer = document.createElement('div');
      barContainer.className = 'leaderboard-item';

      const profileLetter = document.createElement('div');
      profileLetter.className = 'profile';
      profileLetter.style.width = '30px';
      profileLetter.style.height = '30px';
      profileLetter.style.fontSize = '16px';
      profileLetter.textContent = user.user_name.charAt(0).toUpperCase();

      const bar = document.createElement('div');
      bar.className = 'leaderboard-bar';
      const fill = document.createElement('div');
      fill.className = 'leaderboard-fill';
      fill.style.width = Math.min(user.minutes_logged, 100) + '%';
      fill.textContent = user.minutes_logged;
      bar.appendChild(fill);

      barContainer.appendChild(profileLetter);
      barContainer.appendChild(bar);

      leaderboardEl.appendChild(barContainer);
    });

    // Load community total
    const { data: totalData } = await supabase
      .from('Userdetails')
      .select('minutes_logged');

    const totalMinutes = totalData.reduce((sum, u) => sum + u.minutes_logged, 0);
    const goalMinutes = 1000000; // can be dynamic
    const percent = Math.min((totalMinutes / goalMinutes) * 100, 100);
    const communityBar = document.getElementById('communityProgress');
    communityBar.style.width = percent + '%';
    communityBar.textContent = `${percent.toFixed(1)}% (${totalMinutes}/${goalMinutes})`;
  }

  loadDashboard();

  // Logging more minutes
  document.getElementById('logMinutesBtn').addEventListener('click', async () => {
    const input = parseInt(document.getElementById('logMinutesInput').value);
    const logMessage = document.getElementById('logMessage');

    if (isNaN(input) || input <= 0 || input > 120) {
      logMessage.textContent = 'Please enter a valid number (1â€“120).';
      return;
    }

    const { data: userData, error } = await supabase
      .from('Userdetails')
      .select('minutes_logged')
      .eq('user_name', username)
      .single();

    if (error) {
      logMessage.textContent = 'Error fetching user data.';
      return;
    }

    const newMinutes = userData.minutes_logged + input;

    const { error: updateError } = await supabase
      .from('Userdetails')
      .update({ minutes_logged: newMinutes })
      .eq('user_name', username);

    if (updateError) {
      logMessage.textContent = 'Error updating minutes.';
      return;
    }

    logMessage.textContent = `Successfully logged ${input} minutes!`;
    document.getElementById('logMinutesInput').value = '';
    loadDashboard();
  });
</script>

</body>
</html>
